{"version":3,"file":"DependencyResolver.js","sourceRoot":"","sources":["../src/DependencyResolver.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,kDAA4B;AAC5B,+CAOuB;AACvB,wFAAiD;AAIjD,iCAA6C;AAY7C,SAAS,MAAM,CAAC,IAAY,EAAE,OAAe;IAC3C,OAAO,OAAO,CAAC,CAAC,CAAI,IAAI,SAAI,OAAS,CAAC,CAAC,CAAC,IAAI,CAAC;AAC/C,CAAC;AAED;IAME,4BAAY,OAIX;QAPO,WAAM,GAAoC,EAAE,CAAC;QAQnD,IAAI,CAAC,YAAY,GAAG,OAAO,CAAC,YAAY,CAAC;QACzC,IAAI,CAAC,MAAM,GAAG,OAAO,CAAC,MAAM,CAAC;QAC7B,IAAI,CAAC,QAAQ,GAAG,OAAO,CAAC,QAAQ,CAAC;IACnC,CAAC;IAED,gCAAG,GAAH,UAAI,IAAY,EAAE,OAAe,EAAE,UAAsB;QACvD,IAAM,GAAG,GAAG,MAAM,CAAC,IAAI,EAAE,OAAO,CAAC,CAAC;QAClC,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,GAAG,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,IAAI,IAAI,CAAC,OAAO,CAAC,GAAG,EAAE,IAAI,EAAE,OAAO,EAAE,UAAU,CAAC,CAAC;QACpF,OAAO,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC;IAC1B,CAAC;IAED,mCAAM,GAAN,UAAO,IAAY,EAAE,OAAe,EAAE,WAAmB;QACvD,OAAO,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC,IAAI,EAAE,OAAO,CAAC,CAAC,CAAC;IAC5C,CAAC;IAEK,8CAAiB,GAAvB;;;;;;wBACM,QAAQ,GAAG,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;;;6BACnC,QAAQ,CAAC,MAAM;wBACpB,qBAAM,OAAO,CAAC,GAAG,CAAC,QAAQ,CAAC,EAAA;;wBAA3B,SAA2B,CAAC;wBAC5B,QAAQ,GAAG,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;;;;;;KAEzC;IAEa,oCAAO,GAArB,UACE,GAAW,EACX,IAAY,EACZ,OAAe,EACf,UAAsB;;;;;;;wBAEhB,gBAAgB,GAAG,UAAU,IAAI,QAAQ,CAAC,CAAC,CAAC,yBAAyB,CAAC,CAAC,CAAC,EAAE,CAAC;wBAC3E,GAAG,GAAM,IAAI,CAAC,YAAY,gBAAW,GAAG,SAAI,gBAAgB,mBAAc,UAAU,+BAA4B,CAAC;wBACvH,MAAA,IAAI,CAAC,MAAM,0CAAE,MAAM,CAAC,sBAAsB,EAAE,GAAG,EAAE,KAAK,EAAE;;;;wBAE7C,CAAC,GAAG,CAAC;;;6BAAE,CAAA,CAAC,GAAG,EAAE,CAAA;wBACR,qBAAM,aAAK,CAAC,GAAG,CAAC,EAAA;;wBAAtB,GAAG,GAAG,SAAgB;wBAC5B,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,EAAE;4BACrB,sBAAO;yBACR;6BACG,CAAA,GAAG,CAAC,MAAM,KAAK,GAAG,CAAA,EAAlB,wBAAkB;wBACP,qBAAM,GAAG,CAAC,IAAI,EAAE,EAAA;;wBAAvB,IAAI,GAAG,SAAgB;6BACzB,IAAI,CAAC,OAAO,EAAZ,wBAAY;wBACd,MAAA,IAAI,CAAC,MAAM,0CAAE,MAAM,CAAC,mCAAmC,EAAE,GAAG,EAAE,sBAAsB,EAAE;wBACtF,qBAAM,IAAI,OAAO,CAAC,UAAC,OAAO,IAAK,OAAA,UAAU,CAAC,OAAO,EAAE,IAAI,CAAC,EAAzB,CAAyB,CAAC,EAAA;;wBAAzD,SAAyD,CAAC;wBAC1D,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,EAAE;4BACrB,sBAAO;yBACR;;;wBAED,MAAA,IAAI,CAAC,MAAM,0CAAE,MAAM,CAAC,qBAAqB,EAAE,GAAG,EAAE,IAAI,EAAE;wBACtD,OAAO,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC;wBACxB,IAAI;4BACF,IAAI,CAAC,QAAQ,CACX;gCACE,IAAI,MAAA;gCACJ,OAAO,SAAA;gCACP,UAAU,YAAA;6BACX,EACD,IAAI,CACL,CAAC;4BACF,sBAAO;yBACR;wBAAC,OAAO,CAAC,EAAE;4BACV,sBAAO,OAAO,CAAC,MAAM,CAAC,CAAC,CAAC,EAAC;yBAC1B;;;4BAGW,qBAAM,GAAG,CAAC,IAAI,EAAE,EAAA;;wBAAxB,KAAK,GAAG,SAAgB;wBAC9B,MAAM,IAAI,KAAK,CAAC,KAAK,CAAC,CAAC;;wBAhCH,CAAC,EAAE,CAAA;;;;;wBAoCrB,KAAK,GAAG,mBAAW,CAAC;4BACxB,OAAO,EAAE,mCAAiC,GAAG,WAAM,GAAC,CAAC,OAAO,MAAG;4BAC/D,QAAQ,EAAE,GAAG;yBACd,CAAC,CAAC;wBACH,MAAA,IAAI,CAAC,MAAM,0CAAE,KAAK,CAAC,KAAK,EAAE;wBAGpB,aAAa,GAAG,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC;wBACzC,IAAI,aAAa,EAAE;4BACjB,OAAO,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC;4BACxB,IAAI,CAAC,QAAQ,CACX;gCACE,IAAI,MAAA;gCACJ,OAAO,SAAA;gCACP,UAAU,YAAA;6BACX,EACD,SAAS,EACT,KAAK,CACN,CAAC;yBACH;;;;;;KAEJ;IACH,yBAAC;AAAD,CAAC,AAtGD,IAsGC;;AAED,SAAgB,sBAAsB,CACpC,YAA+B,EAC/B,UAAsB,EACtB,wBAAkD;;IAElD,IAAM,MAAM,GAA6B,EAAE,CAAC;IAC5C,KAAK,IAAM,MAAI,IAAI,YAAY,EAAE;QAC/B,IAAM,GAAG,GAAG,YAAY,CAAC,MAAI,CAAC,CAAC;QAC/B,IAAI,GAAG,CAAC,gBAAgB,EAAE;YACxB,KAAK,IAAM,QAAQ,IAAI,GAAG,CAAC,gBAAgB,EAAE;gBAC3C,IAAI,CAAC,iCAAiB,CAAC,QAAQ,EAAE,UAAU,EAAE,IAAI,CAAC,IAAI,CAAC,YAAY,CAAC,QAAQ,CAAC,EAAE;oBAC7E,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,EAAE;wBACrB,MAAM,CAAC,QAAQ,CAAC,GAAG;4BACjB,UAAU,EAAE,CAAC,MAAI,CAAC;4BAClB,aAAa,cACX,wBAAwB,aAAxB,wBAAwB,uBAAxB,wBAAwB,CAAG,QAAQ,oCAAK,GAAG,CAAC,gBAAgB,CAAC,QAAQ,CAAC,mCAAI,GAAG;yBAChF,CAAC;qBACH;yBAAM;wBACL,IAAI,aAAa,GAAuB,wBAAwB,aAAxB,wBAAwB,uBAAxB,wBAAwB,CAAG,QAAQ,CAAC,CAAC;wBAC7E,IAAI,CAAC,aAAa,EAAE;4BAClB,aAAa,GAAG,MAAM,CAAC,QAAQ,CAAC,CAAC,aAAa,CAAC;4BAC/C,IAAM,OAAO,GAAG,GAAG,CAAC,gBAAgB,CAAC,QAAQ,CAAC,IAAI,GAAG,CAAC;4BACtD,2CAA2C;4BAC3C,IACE,aAAa,KAAK,GAAG;gCACrB,CAAC,OAAO,KAAK,QAAQ,IAAI,aAAa,KAAK,QAAQ,CAAC;gCACpD,CAAC,OAAO,KAAK,GAAG;oCACd,OAAO,KAAK,QAAQ;oCACpB,CAAC,aAAa,KAAK,QAAQ;wCACzB,gBAAM,CAAC,EAAE,CAAC,gBAAM,CAAC,MAAM,CAAC,OAAO,CAAE,EAAE,gBAAM,CAAC,MAAM,CAAC,aAAc,CAAE,CAAC,CAAC,CAAC,EACxE;gCACA,aAAa,GAAG,OAAO,CAAC;6BACzB;yBACF;wBACD,MAAM,CAAC,QAAQ,CAAC,GAAG;4BACjB,UAAU,iBAAM,MAAM,CAAC,QAAQ,CAAC,CAAC,UAAU,GAAE,MAAI,EAAC;4BAClD,aAAa,eAAA;yBACd,CAAC;qBACH;iBACF;aACF;SACF;KACF;IACD,OAAO,MAAM,CAAC;AAChB,CAAC;AA5CD,wDA4CC;AAED,SAAgB,gBAAgB,CAAC,IAAY,EAAE,OAAe;IACxD,IAAA,KAAkC,mCAAQ,CAAC,IAAI,CAAC,EAA9C,mBAAmB,yBAAA,EAAE,MAAM,YAAmB,CAAC;IACrD,IAAI,CAAC,mBAAmB,EAAE;QACxB,wFAAwF;QACxF,IAAM,KAAK,GAAG,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;QAC9B,IAAI,KAAK,CAAC,MAAM,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,UAAU,CAAC,GAAG,CAAC,EAAE;YAC9C,IAAM,MAAM,GAAG,mCAAQ,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC;YAClC,mBAAmB,GAAG,MAAM,CAAC,mBAAmB,CAAC;YACjD,MAAM,GAAG,MAAM,CAAC,MAAM,CAAC;SACxB;aAAM,IAAI,KAAK,CAAC,MAAM,IAAI,CAAC,IAAI,IAAI,CAAC,UAAU,CAAC,GAAG,CAAC,EAAE;YACpD,IAAM,MAAM,GAAG,mCAAQ,CAAC,KAAK,CAAC,CAAC,CAAC,GAAG,GAAG,GAAG,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC;YACnD,mBAAmB,GAAG,MAAM,CAAC,mBAAmB,CAAC;YACjD,MAAM,GAAG,MAAM,CAAC,MAAM,CAAC;SACxB;QAED,IAAI,CAAC,mBAAmB,EAAE;YACxB,OAAO,mBAAW,CAAC;gBACjB,OAAO,EAAE,yBAAuB,IAAI,WAAK,CAAA,MAAM,aAAN,MAAM,uBAAN,MAAM,CAAE,MAAM,EAAC,CAAC,CAAC,MAAI,MAAM,CAAC,CAAC,CAAC,MAAG,CAAC,CAAC,CAAC,EAAE,CAAE;gBACjF,QAAQ,EAAE,IAAI;aACf,CAAC,CAAC;SACJ;KACF;IACD,IAAI,CAAC,6BAAa,CAAC,OAAO,CAAC,EAAE;QAC3B,OAAO,mBAAW,CAAC;YACjB,OAAO,EAAE,yBAAuB,IAAI,oBAAe,OAAO,6BAA0B;YACpF,QAAQ,EAAE,IAAI;SACf,CAAC,CAAC;KACJ;IACD,OAAO,SAAS,CAAC;AACnB,CAAC;AA7BD,4CA6BC;AAED,SAAgB,cAAc,CAAC,IAAY;IACzC,IAAM,KAAK,GAAG,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;IAC9B,IAAI,KAAK,CAAC,CAAC,CAAC,CAAC,UAAU,CAAC,GAAG,CAAC,IAAI,KAAK,CAAC,MAAM,IAAI,CAAC,EAAE;QACjD,OAAU,KAAK,CAAC,CAAC,CAAC,SAAI,KAAK,CAAC,CAAC,CAAG,CAAC;KAClC;SAAM;QACL,OAAO,KAAK,CAAC,CAAC,CAAC,CAAC;KACjB;AACH,CAAC;AAPD,wCAOC","sourcesContent":["import semver from 'semver';\nimport {\n  SDKVersion,\n  SnackDependencies,\n  SnackMissingDependencies,\n  SnackDependencyVersions,\n  isModulePreloaded,\n  isValidSemver,\n} from 'snack-content';\nimport validate from 'validate-npm-package-name';\n\nimport { Logger } from './Logger';\nimport { SnackError } from './types';\nimport { fetch, createError } from './utils';\n\nexport type DependencyResolverCallback = (\n  request: {\n    name: string;\n    version: string;\n    sdkVersion: SDKVersion;\n  },\n  result?: any,\n  error?: SnackError,\n) => any;\n\nfunction getKey(name: string, version: string) {\n  return version ? `${name}@${version}` : name;\n}\n\nexport default class DependencyResolver {\n  private snackagerURL: string;\n  private logger?: Logger;\n  private status: { [key: string]: Promise<any> } = {};\n  private callback: DependencyResolverCallback;\n\n  constructor(options: {\n    snackagerURL: string;\n    logger?: Logger;\n    callback: DependencyResolverCallback;\n  }) {\n    this.snackagerURL = options.snackagerURL;\n    this.logger = options.logger;\n    this.callback = options.callback;\n  }\n\n  add(name: string, version: string, sdkVersion: SDKVersion) {\n    const key = getKey(name, version);\n    this.status[key] = this.status[key] || this.resolve(key, name, version, sdkVersion);\n    return this.status[key];\n  }\n\n  remove(name: string, version: string, _sdkVersion: string) {\n    delete this.status[getKey(name, version)];\n  }\n\n  async waitForCompletion() {\n    let promises = Object.values(this.status);\n    while (promises.length) {\n      await Promise.all(promises);\n      promises = Object.values(this.status);\n    }\n  }\n\n  private async resolve(\n    key: string,\n    name: string,\n    version: string,\n    sdkVersion: SDKVersion,\n  ): Promise<any> {\n    const versionSnackager = sdkVersion >= '37.0.0' ? 'version_snackager=true&' : '';\n    const url = `${this.snackagerURL}/bundle/${key}?${versionSnackager}sdkVersion=${sdkVersion}&platforms=ios,android,web`;\n    this.logger?.module('Resolving dependency', key, '...');\n    try {\n      for (let i = 0; i < 30; i++) {\n        const res = await fetch(url);\n        if (!this.status[key]) {\n          return;\n        }\n        if (res.status === 200) {\n          const data = await res.json();\n          if (data.pending) {\n            this.logger?.module('Dependency is still being bundled', key, 'trying again shortly');\n            await new Promise((resolve) => setTimeout(resolve, 5000));\n            if (!this.status[key]) {\n              return;\n            }\n          } else {\n            this.logger?.module('Resolved dependency', key, data);\n            delete this.status[key];\n            try {\n              this.callback(\n                {\n                  name,\n                  version,\n                  sdkVersion,\n                },\n                data,\n              );\n              return;\n            } catch (e) {\n              return Promise.reject(e);\n            }\n          }\n        } else {\n          const error = await res.text();\n          throw new Error(error);\n        }\n      }\n    } catch (e) {\n      const error = createError({\n        message: `Failed to resolve dependency '${key}' (${e.message})`,\n        fileName: key,\n      });\n      this.logger?.error(error);\n      // TypeScript thinks we need to await this promise, but we are actually checking if there is a promise or not. TS2801\n      // ESLint doesn't like when we cast to a boolean inside of an if statement. no-extra-boolean-cast\n      const promiseExists = !!this.status[key];\n      if (promiseExists) {\n        delete this.status[key];\n        this.callback(\n          {\n            name,\n            version,\n            sdkVersion,\n          },\n          undefined,\n          error,\n        );\n      }\n    }\n  }\n}\n\nexport function getMissingDependencies(\n  dependencies: SnackDependencies,\n  sdkVersion: SDKVersion,\n  wantedDependencyVersions?: SnackDependencyVersions,\n): SnackMissingDependencies {\n  const result: SnackMissingDependencies = {};\n  for (const name in dependencies) {\n    const dep = dependencies[name];\n    if (dep.peerDependencies) {\n      for (const peerName in dep.peerDependencies) {\n        if (!isModulePreloaded(peerName, sdkVersion, true) && !dependencies[peerName]) {\n          if (!result[peerName]) {\n            result[peerName] = {\n              dependents: [name],\n              wantedVersion:\n                wantedDependencyVersions?.[peerName] ?? dep.peerDependencies[peerName] ?? '*',\n            };\n          } else {\n            let wantedVersion: string | undefined = wantedDependencyVersions?.[peerName];\n            if (!wantedVersion) {\n              wantedVersion = result[peerName].wantedVersion;\n              const version = dep.peerDependencies[peerName] || '*';\n              // Select the highest most specific version\n              if (\n                wantedVersion === '*' ||\n                (version === 'latest' && wantedVersion === 'latest') ||\n                (version !== '*' &&\n                  version !== 'latest' &&\n                  (wantedVersion === 'latest' ||\n                    semver.gt(semver.coerce(version)!, semver.coerce(wantedVersion!)!)))\n              ) {\n                wantedVersion = version;\n              }\n            }\n            result[peerName] = {\n              dependents: [...result[peerName].dependents, name],\n              wantedVersion,\n            };\n          }\n        }\n      }\n    }\n  }\n  return result;\n}\n\nexport function verifyDependency(name: string, version: string): SnackError | undefined {\n  let { validForOldPackages, errors } = validate(name);\n  if (!validForOldPackages) {\n    // Also support code inside packages such as \"react-native-gesture-handler/DrawerLayout\"\n    const names = name.split('/');\n    if (names.length >= 2 && !name.startsWith('@')) {\n      const result = validate(names[0]);\n      validForOldPackages = result.validForNewPackages;\n      errors = result.errors;\n    } else if (names.length >= 2 && name.startsWith('@')) {\n      const result = validate(names[0] + '/' + names[1]);\n      validForOldPackages = result.validForNewPackages;\n      errors = result.errors;\n    }\n\n    if (!validForOldPackages) {\n      return createError({\n        message: `Invalid dependency '${name}' ${errors?.length ? `(${errors[0]})` : ''}`,\n        fileName: name,\n      });\n    }\n  }\n  if (!isValidSemver(version)) {\n    return createError({\n      message: `Invalid dependency '${name}' (version '${version}' is not a valid semver)`,\n      fileName: name,\n    });\n  }\n  return undefined;\n}\n\nexport function getPackageName(name: string): string {\n  const names = name.split('/');\n  if (names[0].startsWith('@') && names.length >= 2) {\n    return `${names[0]}/${names[1]}`;\n  } else {\n    return names[0];\n  }\n}\n"]}